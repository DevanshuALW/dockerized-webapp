name: CI/CD - Deploy Dockerized App to AWS EC2

on:
    push:
          branches:
                  - main  # Trigger workflow on push to main branch

          jobs:
              deploy:
                    runs-on: ubuntu-latest

                        steps:
                                - name: Checkout repository
                                        uses: actions/checkout@v3

                                              - name: Set up Docker
                                                      uses: docker/setup-buildx-action@v3

                                                            - name: Build Docker image
                                                                    run: |
                                                                                docker build -t flask-docker-app .

                                                                                      - name: Save Docker image as tar
                                                                                              run: docker save flask-docker-app -o flask-docker-app.tar

                                                                                                    - name: Copy Docker image to EC2
                                                                                                            uses: appleboy/scp-action@v0.1.4
                                                                                                                    with:
                                                                                                                                host: ${{ secrets.EC2_HOST }}
                                                                                                                                          username: ${{ secrets.EC2_USER }}
                                                                                                                                                    key: ${{ secrets.EC2_SSH_KEY }}
                                                                                                                                                              source: "flask-docker-app.tar"
                                                                                                                                                                        target: "/home/ubuntu/"

                                                                                                                                                                              - name: Deploy on EC2
                                                                                                                                                                                      uses: appleboy/ssh-action@v0.1.10
                                                                                                                                                                                              with:
                                                                                                                                                                                                          host: ${{ secrets.EC2_HOST }}
                                                                                                                                                                                                                    username: ${{ secrets.EC2_USER }}
                                                                                                                                                                                                                              key: ${{ secrets.EC2_SSH_KEY }}
                                                                                                                                                                                                                                        script: |
                                                                                                                                                                                                                                                      sudo docker load -i flask-docker-app.tar
                                                                                                                                                                                                                                                                  sudo docker stop webapp || true
                                                                                                                                                                                                                                                                              sudo docker rm webapp || true
                                                                                                                                                                                                                                                                                          sudo docker run -d -p 80:5000 --name webapp flask-docker-app
